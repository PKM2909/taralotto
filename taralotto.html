<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARA Lottery DApp</title>
    <!-- Using unpkg for better reliability for ethers.js -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        input[type="text"], input[type="number"] { padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .status { margin-top: 15px; padding: 10px; background-color: #e0f2f7; border-left: 5px solid #2196F3; }
        .error { background-color: #ffe0e0; border-left: 5px solid #f44336; }
        .player-list { list-style-type: none; padding: 0; }
        .player-list li { background-color: #f9f9f9; margin-bottom: 5px; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TARA Community Lottery ðŸŽ²</h1>
        <p>Play with TARA and win big!</p>

        <div class="status" id="statusMessage">Connect your wallet to get started.</div>

        <h2>Wallet Connection</h2>
        <button id="connectWalletBtn">Connect Rabby Wallet</button>
        <p>Connected Account: <span id="accountAddress">Not Connected</span></p>
        <p>Network ID: <span id="networkId"></span></p>

        <hr>

        <h2>Lottery Details</h2>
        <p>Lottery ID: <span id="lotteryId">N/A</span></p>
        <p>Ticket Price: <span id="ticketPrice">N/A</span> TARA</p>
        <p>Prize Pool: <span id="prizePool">N/A</span> TARA</p>
        <p>Current Players: <span id="numPlayers">N/A</span></p>
        <p>Winner of Last Round: <span id="currentWinner">N/A</span></p>
        <button id="refreshDetailsBtn">Refresh Details</button>

        <hr>

        <h2>Play Lottery</h2>
        <p>Cost per entry: <span id="entryCostSpan">Loading...</span> TARA</p>
        <p>Your TARA Balance: <span id="taraBalance">Loading...</span> TARA</p>
        <button id="enterLotteryBtn">Enter Lottery</button>

        <hr>

        <h2>Manager Actions (Owner Only)</h2>
        <button id="pickWinnerBtn">Pick Winner & Reset</button>
        <p>Accumulated Owner Fees: <span id="ownerFeesAccumulated">N/A</span> TARA</p>
        <button id="collectOwnerFeesBtn">Collect Owner Fees</button>

        <hr>

        <h2>Players in Current Round</h2>
        <ul id="playersList" class="player-list">
            <li>No players yet...</li>
        </ul>

    </div>

    <script>
        // --- CONFIGURATION ---
        // Your Deployed TARA Lottery Contract Address on Taraxa Mainnet
        const TARA_LOTTERY_CONTRACT_ADDRESS = "0xf43a5a4d4e8f41decab48980ed96e14a1eb246fb"; 
        const TARAXA_MAINNET_CHAIN_ID = 841; // Taraxa Mainnet Chain ID

        // --- ABI for TARA Lottery Contract ---
        // This ABI is from your successfully deployed TARALottery contract
        const TARA_LOTTERY_ABI = [
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_initialTicketPrice", "type": "uint256" },
                    { "internalType": "uint256", "name": "_ownerFeePercent", "type": "uint256" },
                    { "internalType": "address", "name": "_initialOwner", "type": "address" }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_player", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_amount", "type": "uint256" }
                ],
                "name": "TicketPurchased",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_newLotteryId", "type": "uint256" }
                ],
                "name": "LotteryReset",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" },
                    { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_winner", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_prizeAmount", "type": "uint256" }
                ],
                "name": "WinnerPicked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "_amount", "type": "uint256" }
                ],
                "name": "OwnerFeeCollected",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "collectOwnerFees",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentWinner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "enter",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractTARABalance",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getOwnerFeesAccumulated",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPlayers",
                "outputs": [{ "internalType": "address[]", "name": "", "type": "address[]" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "lotteryId",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ownerFeePercentage",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "pickWinner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_newFeePercent", "type": "uint256" }
                ],
                "name": "setOwnerFeePercentage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_newPrice", "type": "uint256" }
                ],
                "name": "setTicketPrice",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ticketPrice",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "newOwner", "type": "address" }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];

        let provider;
        let signer;
        let userAddress;
        let lotteryContract;

        const statusMessage = document.getElementById('statusMessage');
        const accountAddress = document.getElementById('accountAddress');
        const networkId = document.getElementById('networkId');
        const lotteryIdSpan = document.getElementById('lotteryId');
        const ticketPriceSpan = document.getElementById('ticketPrice');
        const prizePoolSpan = document.getElementById('prizePool');
        const numPlayersSpan = document.getElementById('numPlayers');
        const currentWinnerSpan = document.getElementById('currentWinner');
        const taraBalanceSpan = document.getElementById('taraBalance');
        const entryCostSpan = document.getElementById('entryCostSpan');
        const playersList = document.getElementById('playersList');
        const ownerFeesAccumulatedSpan = document.getElementById('ownerFeesAccumulated'); // New element

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const enterLotteryBtn = document.getElementById('enterLotteryBtn');
        const pickWinnerBtn = document.getElementById('pickWinnerBtn');
        const refreshDetailsBtn = document.getElementById('refreshDetailsBtn');
        const collectOwnerFeesBtn = document.getElementById('collectOwnerFeesBtn'); // New button

        // --- Helper Functions ---
        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'status error' : 'status';
        }

        async function updateUI() {
            if (!provider || !userAddress || !lotteryContract) {
                enterLotteryBtn.disabled = true;
                pickWinnerBtn.disabled = true;
                collectOwnerFeesBtn.disabled = true; // Disable new button too
                return;
            }

            try {
                // Get Lottery Details
                const currentLotteryId = await lotteryContract.lotteryId();
                const currentTicketPriceWei = await lotteryContract.ticketPrice();
                const players = await lotteryContract.getPlayers();
                const winnerAddress = await lotteryContract.currentWinner();
                const accumulatedFeesWei = await lotteryContract.getOwnerFeesAccumulated(); // Get accumulated fees

                // Get Contract's TARA Balance (Prize Pool)
                const prizePoolWei = await provider.getBalance(TARA_LOTTERY_CONTRACT_ADDRESS);

                lotteryIdSpan.textContent = currentLotteryId.toString();
                ticketPriceSpan.textContent = ethers.utils.formatEther(currentTicketPriceWei);
                prizePoolSpan.textContent = ethers.utils.formatEther(prizePoolWei); 
                numPlayersSpan.textContent = players.length;
                currentWinnerSpan.textContent = winnerAddress === '0x0000000000000000000000000000000000000000' ? 'N/A (No winner yet or reset)' : winnerAddress;
                ownerFeesAccumulatedSpan.textContent = ethers.utils.formatEther(accumulatedFeesWei); // Display accumulated fees

                playersList.innerHTML = '';
                if (players.length > 0) {
                    players.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player;
                        playersList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No players yet. Be the first!';
                    playersList.appendChild(li);
                }

                // Get User TARA Balance
                const userTaraBalanceWei = await provider.getBalance(userAddress);
                taraBalanceSpan.textContent = ethers.utils.formatEther(userTaraBalanceWei);
                entryCostSpan.textContent = ethers.utils.formatEther(currentTicketPriceWei);

                // Enable/Disable Enter Lottery button based on TARA balance
                if (userTaraBalanceWei.lt(currentTicketPriceWei)) {
                    enterLotteryBtn.disabled = true;
                    setStatus("Insufficient TARA balance to enter lottery. Please acquire more TARA.", true);
                } else {
                    enterLotteryBtn.disabled = false;
                    setStatus("Wallet connected. Ready to play!");
                }
                
                // Check if user is owner for manager buttons
                const contractOwner = await lotteryContract.owner();
                if (userAddress.toLowerCase() === contractOwner.toLowerCase()) {
                    pickWinnerBtn.disabled = false;
                    collectOwnerFeesBtn.disabled = (accumulatedFeesWei.isZero()); // Enable collect fees only if there are fees
                } else {
                    pickWinnerBtn.disabled = true;
                    collectOwnerFeesBtn.disabled = true;
                }

            } catch (error) {
                setStatus(`Error updating UI: ${error.message}`, true);
                console.error("UI Update Error:", error);
                enterLotteryBtn.disabled = true;
                pickWinnerBtn.disabled = true;
                collectOwnerFeesBtn.disabled = true;
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.ethereum === 'undefined') {
                setStatus("Rabby Wallet (or MetaMask) not detected. Please install it.", true);
                connectWalletBtn.disabled = true;
            } else {
                enterLotteryBtn.disabled = true;
                pickWinnerBtn.disabled = true;
                collectOwnerFeesBtn.disabled = true;
            }
        });

        connectWalletBtn.addEventListener('click', async () => {
            try {
                if (!window.ethereum) {
                    throw new Error("Rabby Wallet not found. Please install it.");
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                accountAddress.textContent = userAddress;

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                networkId.textContent = parseInt(chainId, 16);

                if (parseInt(chainId, 16) !== TARAXA_MAINNET_CHAIN_ID) {
                    setStatus(`Please switch your wallet to Taraxa Mainnet (Chain ID ${TARAXA_MAINNET_CHAIN_ID}).`, true);
                    enterLotteryBtn.disabled = true;
                    pickWinnerBtn.disabled = true;
                    collectOwnerFeesBtn.disabled = true;
                    return; 
                }

                signer = provider.getSigner();

                // Initialize contract instance
                lotteryContract = new ethers.Contract(TARA_LOTTERY_CONTRACT_ADDRESS, TARA_LOTTERY_ABI, signer);

                setStatus("Wallet connected and contracts loaded. Fetching lottery details...");
                updateUI();

                // Listen for account/network changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    userAddress = accounts[0];
                    accountAddress.textContent = userAddress || 'Not Connected';
                    setStatus(userAddress ? "Account changed. Updating UI..." : "Disconnected.", userAddress ? false : true);
                    updateUI();
                });
                window.ethereum.on('chainChanged', (chainId) => {
                    networkId.textContent = parseInt(chainId, 16);
                    setStatus(`Network changed to ${parseInt(chainId, 16)}. Please ensure it's Taraxa Mainnet.`, true);
                    window.location.reload(); // Reload for full re-initialization
                });

            } catch (error) {
                setStatus(`Wallet connection failed: ${error.message}`, true);
                console.error(error);
                enterLotteryBtn.disabled = true;
                pickWinnerBtn.disabled = true;
                collectOwnerFeesBtn.disabled = true;
            }
        });

        enterLotteryBtn.addEventListener('click', async () => {
            if (!signer || !lotteryContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            
            try {
                const currentTicketPriceWei = await lotteryContract.ticketPrice();
                const userTaraBalanceWei = await provider.getBalance(userAddress);

                if (userTaraBalanceWei.lt(currentTicketPriceWei)) {
                    setStatus("Cannot enter: Insufficient TARA balance.", true);
                    return;
                }

                setStatus("Entering lottery...");
                // Send TARA with the transaction using the value option
                const tx = await lotteryContract.enter({ value: currentTicketPriceWei });
                console.log(`Enter Lottery transaction sent: ${tx.hash}`);
                await tx.wait();
                setStatus("Successfully entered the lottery!");
                updateUI();
            } catch (error) {
                setStatus(`Entering lottery failed: ${error.message}. Please ensure you have enough TARA.`, true);
                console.error("Enter lottery error:", error);
                console.error("Full Ethers.js error object:", JSON.stringify(error, null, 2));
            }
        });

        pickWinnerBtn.addEventListener('click', async () => {
            if (!signer || !lotteryContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            
            const contractOwner = await lotteryContract.owner();
            if (userAddress.toLowerCase() !== contractOwner.toLowerCase()) {
                setStatus("Only the contract owner can pick a winner.", true);
                return;
            }

            try {
                setStatus("Picking winner and resetting lottery...");
                const tx = await lotteryContract.pickWinner();
                console.log(`Pick Winner transaction sent: ${tx.hash}`);
                await tx.wait();
                setStatus("Winner picked, prize distributed, lottery reset!");
                updateUI();
            } catch (error) {
                setStatus(`Picking winner failed: ${error.message}`, true);
                console.error("Pick winner error:", error);
                console.error("Full Ethers.js error object:", JSON.stringify(error, null, 2));
            }
        });

        collectOwnerFeesBtn.addEventListener('click', async () => {
            if (!signer || !lotteryContract) {
                setStatus("Please connect wallet first.", true);
                return;
            }
            
            const contractOwner = await lotteryContract.owner();
            if (userAddress.toLowerCase() !== contractOwner.toLowerCase()) {
                setStatus("Only the contract owner can collect fees.", true);
                return;
            }

            try {
                setStatus("Collecting owner fees...");
                const tx = await lotteryContract.collectOwnerFees();
                console.log(`Collect Owner Fees transaction sent: ${tx.hash}`);
                await tx.wait();
                setStatus("Owner fees collected successfully!");
                updateUI();
            } catch (error) {
                setStatus(`Collecting owner fees failed: ${error.message}`, true);
                console.error("Collect owner fees error:", error);
                console.error("Full Ethers.js error object:", JSON.stringify(error, null, 2));
            }
        });

        refreshDetailsBtn.addEventListener('click', updateUI);

        // Initial UI update if wallet is already connected (e.g., after refresh)
        if (window.ethereum && window.ethereum.selectedAddress) {
            setTimeout(() => {
                connectWalletBtn.click(); // Simulate click to connect
            }, 100);
        }

    </script>
</body>
</html>
